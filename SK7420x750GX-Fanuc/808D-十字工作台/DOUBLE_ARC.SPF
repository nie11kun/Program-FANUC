;Double_Arc.Spf
;ahxinny 2017-4-11 [Ver 1.0]
;==========================
;双圆弧,参数传递
R280=R170  ;齿型相对修整轮左圆弧半径
R281=R170  ;齿型相对修整轮右圆弧半径
R282=R167  ;右修整轮对砂轮中心
R286=R167  ;左修整轮对砂轮中心

R283=R166  ;当前右端接触位置
R287=R166  ;当前左端接触位置

R284=1000  ;快速定位速度
R285=1000  ;快退速度
;==========================

;左侧滚道圆弧点位计算
R240=R270+R280
R241=SQRT((R240*R240)-(R271*R271));第二点的W值
R242=R270-R271;第二点的V值
R243=(R176/2)+2+R271;终点W值
R244=R242+(TAN(45)*(R243-R241));终点V值

;右侧滚道圆弧点位计算
R245=R272+R281
R246=SQRT((R245*R245)-(R273*R273));第二点的W值
R247=R272-R273;第二点的V值
R248=(R176/2)+2+R273;终点W值
R249=R247+(TAN(45)*(R248-R246));终点V值

M13  ;砂轮启动
R179=R178*60000/($pi*R180)   ;R180=114,R178=15
M3 S=R179 ;滚压轮启动
G4 F3
M7       ;修整冷却
IF R220<=0
R220=1000
ENDIF

R188=(R249-R281)
if R244-R280>R188
R188=(R244-R280)
endif
R188=R188-R170*(1-SIN(45))

if R187<>0  ;非新砂轮
R172=R166  ;对刀点V
R173=R177  ;假想砂轮直径
else
R172=R171+R188
R173=R177+R188*2
endif

R161=0;修整计数
R185=0 ;修整量累计
R182=0 ;新砂轮毛坯修整计数

G1 G94 G90 V=R172+2 F=R284

Begin:
R220=R162  ;粗修速度
R131=R164  ;进刀量
IF R161>=R160-1
R220=R163  ;精修
R131=R165
ENDIF
IF R161>R160 GOTOF END

R172=R172-R131  ;修整进刀量
;右侧滚道圆弧运行区
R283=R172
TRANS W=R273+R282 V=R283;右圆弧TRANS坐标点,以水平偏心量为起刀点

;MSG("砂轮到位中")
;G1 G94 G90 V=2 F=R284
G1 G90 W=0 F=600
G1 G94 G90 V=0 F=300
;MSG("水平到位中")

;MSG("右圆弧修整中")
IF R173<=R177
MSG("右边(-):第"<<R161+1<<"次修整,还剩"<<R160-R161-1<<"次,修整量"<<R131<<"mm")
else
MSG("右边(-):第"<<R182+1<<"次毛坯修整,修整量"<<R131<<"mm")
endif
G3 W=-R246 V=-R247-R281 CR=R272+R281 F=R220;滚道圆弧段
G1 G90 W=-R248 V=-R249-R281;右侧退刀斜线段
;MSG("砂轮回退中")
G1 G90 V=0 F=R285
W=0
TRANS

;左侧滚道圆弧运行区
R287=R172
TRANS W=-R271+R286 V=R287;左圆弧TRANS坐标点,以水平偏心量为起刀点

;MSG("砂轮到位中")
;G1 G90 V=2 F=R284
G1 G90 W=0 F=600
G1 G90 V=0 F=300
;MSG("水平到位中")

;MSG("左圆弧修整中")
IF R173<=R177
MSG("左边(+):第"<<R161+1<<"次修整,还剩"<<R160-R161-1<<"次,修整量"<<R131<<"mm")
else
MSG("左边(+):第"<<R182+1<<"次毛坯修整,修整量"<<R131<<"mm")
endif

G2 W=R241 V=-R242-R280 CR=R270+R280 F=R220;滚道圆弧段
G1 G90 W=R243 V=-R244-R280;左侧退刀斜线段
;MSG("砂轮回退中")
G1 G90 V=0 F=R285

STOPRE
R173=R173-2*R131  ;假想砂轮直径
R174=R175*$pi*R177/60000  ;砂轮线速度
R187=1  ;砂轮标志

IF R173>=R177  ;新砂轮未修出
R182=R182+1
GOTOB BEGIN
ELSE
R177=R173
R185=R185+R131  ;修整量累计
R166=R172
R161=R161+1
ENDIF

IF R161<R160 GOTOB BEGIN
G91 G64 G01 V=1 F=R285
G90 G64 G01 W=0 F=R285

End:
TRANS
M5 M9   ;滚压轮停止
;M15  ;砂轮停止
G90 G64 G01 V=R172+3 F=3*R220
M17
